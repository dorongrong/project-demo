<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  style="height: 100%"
>
  <style>
    html,
    body {
      height: 100%;
      min-width: 30%;
    }
  </style>
  <th:block th:replace="~{fragments/head :: head}"></th:block>
  <body style="background-color: #343a40">
    <th:block th:replace="~{fragments/header :: header}"></th:block>
    <th:block layout:fragment="content"></th:block>
  </body>
  <script type="module" th:inline="javascript">
    const sockJs = new SockJS("http://localhost:1234/stomp/chat");
    const stomp = webstomp.over(sockJs);
    const cookies = getCookie();
    const decodeCookie = jwtDecode(cookies);
    const itemsId = decodeCookie.itemsId;

    function getCookie() {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();

        const [cookieName, cookieValue] = cookie.split("=");
        if (cookieName === "Authorization") {
          return cookieValue;
        }
      }
      return null;
    }

    console.log("Authorization 쿠키 값:", itemsId);

    function onError(e) {
      console.log("STOMP ERROR", e);
    }

    function onDebug(m) {
      console.log("STOMP DEBUG", m);
    }

    stomp.debug = onDebug;

    // 소켓연결
    stomp.connect(
      "guest",
      "guest",
      function (frame) {
        console.log("STOMP Connected");
        /* subscribe 설정에 따라 rabbit의 Exchange, Queue가 상당히 많이 바뀜 */
        console.log(itemsId);
        itemsId.forEach((id) => {
          stomp.subscribe(`/exchange/chat.exchange/${id}.*`);
        });
      },
      onError,
      "/"
    );

    function findAddr() {
      new daum.Postcode({
        oncomplete: function (data) {
          var addr = ""; // 주소 변수
          var extraAddr = ""; // 참고항목 변수

          if (data.userSelectedType === "R") {
            // 사용자가 도로명 주소를 선택했을 경우
            addr = data.roadAddress;
          } else {
            // 사용자가 지번 주소를 선택했을 경우(J)
            addr = data.jibunAddress;
          }

          // 사용자가 선택한 주소가 도로명 타입일때 참고항목을 조합한다.
          if (data.userSelectedType === "R") {
            if (data.bname !== "" && /[동|로|가]$/g.test(data.bname)) {
              extraAddr += data.bname;
            }

            if (data.buildingName !== "" && data.apartment === "Y") {
              extraAddr +=
                extraAddr !== "" ? ", " + data.buildingName : data.buildingName;
            }

            if (extraAddr !== "") {
              extraAddr = " (" + extraAddr + ")";
            }

            document.getElementById("addressDto.detailAdr").value = extraAddr;
          } else {
            document.getElementById("addressDto.detailAdr").value = "";
          }

          // 우편번호와 주소 정보를 해당 필드에 넣는다.
          document.getElementById("addressDto.zipcode").value = data.zonecode;
          document.getElementById("addressDto.streetAdr").value = addr;
          // 커서를 상세주소 필드로 이동한다.
          document.getElementById("addressDto.detailAdr").focus();
        },
      }).open();
    }
  </script>
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</html>
